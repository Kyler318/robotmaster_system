<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboMaster æ¥µé€Ÿäº‚é¬¥ç®¡ç†ç³»çµ± v3.0</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // â˜…â˜…â˜… è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨çš„ Firebase Config â˜…â˜…â˜…
        const firebaseConfig = {
            aapiKey: "AIzaSyBdAMarLmul5OZgC_yIBs_pfkDvA2BWLFM",
            authDomain: "robomaster-competition.firebaseapp.com",
            projectId: "robomaster-competition",
            storageBucket: "robomaster-competition.firebasestorage.app",
            messagingSenderId: "681333907764",
            appId: "1:681333907764:web:f5fb267d6f7527a1348561"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const currentView = ref('schedule'); 
                const adminStage = ref('prelim'); 
                const newPlayerName = ref('');
                const newPlayerGroup = ref('A');
                const players = ref([]);
                const matches = ref([]);

                onMounted(() => {
                    onSnapshot(collection(db, "players"), (snapshot) => {
                        players.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                    onSnapshot(collection(db, "matches"), (snapshot) => {
                        matches.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                });

                // --- æ•¸æ“šæ“ä½œ ---
                const generateTestData = async () => {
                    if (!confirm("ç”Ÿæˆ60åæ¸¬è©¦é¸æ‰‹ï¼Ÿ")) return;
                    const batch = writeBatch(db);
                    for (let i = 1; i <= 32; i++) {
                        batch.set(doc(collection(db, "players")), { name: `Açµ„-${i}`, group: 'A', status: 'registered' });
                    }
                    for (let i = 1; i <= 28; i++) {
                        batch.set(doc(collection(db, "players")), { name: `Bçµ„-${i}`, group: 'B', status: 'registered' });
                    }
                    await batch.commit();
                };

                const addPlayer = async () => {
                    if (!newPlayerName.value) return;
                    await addDoc(collection(db, "players"), { name: newPlayerName.value, group: newPlayerGroup.value });
                    newPlayerName.value = '';
                    alert("æˆåŠŸ");
                };

                const resetData = async () => {
                   if(!confirm("âš ï¸ ç¢ºå®šæ¸…ç©ºæ‰€æœ‰æ•¸æ“šï¼Ÿ")) return;
                   const pSnaps = await getDocs(collection(db, "players"));
                   pSnaps.forEach(d => deleteDoc(doc(db, "players", d.id)));
                   const mSnaps = await getDocs(collection(db, "matches"));
                   mSnaps.forEach(d => deleteDoc(doc(db, "matches", d.id)));
                };

                // --- è³½ç¨‹ç”Ÿæˆé‚è¼¯ ---
                const shuffle = (array) => array.sort(() => Math.random() - 0.5);

                const generatePrelims = async () => {
                    const activePlayerIds = new Set();
                    matches.value.forEach(m => m.players.forEach(p => activePlayerIds.add(p.id)));
                    
                    const unassignedA = players.value.filter(p => p.group === 'A' && !activePlayerIds.has(p.id));
                    const unassignedB = players.value.filter(p => p.group === 'B' && !activePlayerIds.has(p.id));

                    if (unassignedA.length === 0 && unassignedB.length === 0) return alert("ç„¡æ–°é¸æ‰‹");

                    const batch = writeBatch(db);
                    let count = 0;
                    
                    const makeMatch = (list, group, room) => {
                        const s = shuffle([...list]);
                        for (let i = 0; i < s.length; i += 4) {
                            const chunk = s.slice(i, i + 4);
                            batch.set(doc(collection(db, "matches")), {
                                round: 'prelim', group, players: chunk, room, winnerId: null, createdAt: Date.now()
                            });
                            count++;
                        }
                    };
                    makeMatch(unassignedA, 'A', 'Room 1');
                    makeMatch(unassignedB, 'B', 'Room 2');

                    await batch.commit();
                    alert(`æ–°å¢ ${count} å ´åˆè³½`);
                };

                const generateSemis = async () => {
                    // ç²å–å°šæœªåƒåŠ åŠæ±ºè³½çš„åˆè³½æ™‰ç´šè€…
                    const activeSemiIds = new Set();
                    matches.value.filter(m => m.round === 'semi').forEach(m => m.players.forEach(p => activeSemiIds.add(p.id)));

                    const winners = matches.value
                        .filter(m => m.round === 'prelim' && m.winnerId)
                        .map(m => m.players.find(p => p.id === m.winnerId))
                        .filter(p => p && !activeSemiIds.has(p.id));

                    if (winners.length === 0) return alert("ç„¡å¾…å®šæ™‰ç´šè€…");

                    const batch = writeBatch(db);
                    const s = shuffle([...winners]);
                    for (let i = 0; i < s.length; i += 3) {
                        batch.set(doc(collection(db, "matches")), {
                            round: 'semi', group: 'Merged', players: s.slice(i, i + 3), 
                            room: i % 2 === 0 ? 'Room 1' : 'Room 2', winnerId: null, createdAt: Date.now()
                        });
                    }
                    await batch.commit();
                    alert("åŠæ±ºè³½ç”Ÿæˆ");
                };

                const generateFinal = async () => {
                    if(matches.value.some(m => m.round === 'final')) {
                        if(!confirm("æ±ºè³½å·²å­˜åœ¨ï¼Œè¦æ–°å¢å—ï¼Ÿ")) return;
                    }
                    const winners = matches.value
                        .filter(m => m.round === 'semi' && m.winnerId)
                        .map(m => m.players.find(p => p.id === m.winnerId));
                    
                    if (winners.length === 0) return alert("ç„¡åŠæ±ºè³½æ™‰ç´šè€…");

                    await addDoc(collection(db, "matches"), {
                        round: 'final', group: 'Final', players: winners, room: 'Main Stage',
                        ranks: [] // ç”¨æ–¼å­˜å„²åæ¬¡ ID [1st_ID, 2nd_ID, 3rd_ID]
                    });
                    alert("æ±ºè³½ç”Ÿæˆ");
                };

                // --- è£åˆ¤åˆ¤å®šé‚è¼¯ ---
                
                // åˆè³½èˆ‡åŠæ±ºè³½ (å–®äººæ™‰ç´š)
                const setWinner = async (match, winnerId) => {
                    if(!confirm("ç¢ºèªæ™‰ç´šï¼Ÿ")) return;
                    await updateDoc(doc(db, "matches", match.id), { winnerId });
                };

                // æ±ºè³½ (å‰ä¸‰åæ’å)
                const toggleFinalRank = async (match, playerId) => {
                    let currentRanks = match.ranks || []; // ç¢ºä¿æ˜¯é™£åˆ—
                    
                    // å¦‚æœé€™å€‹äººå·²ç¶“åœ¨æ’åè£¡ï¼Œå°‡ä»–ç§»é™¤ (å–æ¶ˆç²ç)
                    if (currentRanks.includes(playerId)) {
                        currentRanks = currentRanks.filter(id => id !== playerId);
                    } else {
                        // å¦‚æœé‚„æ²’æ»¿3äººï¼ŒåŠ å…¥æ’å
                        if (currentRanks.length < 3) {
                            currentRanks.push(playerId);
                        } else {
                            alert("å‰ä¸‰åå·²æ»¿ï¼è«‹å…ˆé»æ“Šå·²ç²çè€…ä»¥å–æ¶ˆï¼Œå†é‡æ–°é¸æ“‡ã€‚");
                            return;
                        }
                    }

                    await updateDoc(doc(db, "matches", match.id), { ranks: currentRanks });
                };

                // è¼”åŠ©é¡¯ç¤ºåæ¬¡
                const getRankDisplay = (match, playerId) => {
                    if (!match.ranks) return null;
                    const index = match.ranks.indexOf(playerId);
                    if (index === 0) return { label: 'ğŸ¥‡ å† è»', color: 'bg-yellow-400 text-yellow-900 border-yellow-600' };
                    if (index === 1) return { label: 'ğŸ¥ˆ äºè»', color: 'bg-gray-300 text-gray-800 border-gray-500' };
                    if (index === 2) return { label: 'ğŸ¥‰ å­£è»', color: 'bg-orange-300 text-orange-900 border-orange-600' };
                    return null;
                };

                const prelimMatches = computed(() => matches.value.filter(m => m.round === 'prelim').sort((a,b)=>a.createdAt - b.createdAt));
                const semiMatches = computed(() => matches.value.filter(m => m.round === 'semi').sort((a,b)=>a.createdAt - b.createdAt));
                const finalMatches = computed(() => matches.value.filter(m => m.round === 'final'));

                return {
                    currentView, adminStage, newPlayerName, newPlayerGroup, players,
                    addPlayer, generateTestData, resetData,
                    generatePrelims, generateSemis, generateFinal,
                    prelimMatches, semiMatches, finalMatches,
                    setWinner, toggleFinalRank, getRankDisplay
                };
            }
        }).mount('#app');
    </script>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">
    <div id="app" class="max-w-6xl mx-auto bg-white shadow-2xl min-h-screen flex flex-col">
        
        <!-- é ‚éƒ¨å°èˆª -->
        <nav class="flex text-lg font-bold text-white bg-slate-900 sticky top-0 z-50">
            <button @click="currentView='schedule'" :class="currentView=='schedule'?'bg-blue-600':'hover:bg-slate-700'" class="flex-1 py-4 transition">ğŸ“Š è§€çœ¾è³½ç¨‹</button>
            <button @click="currentView='checkin'" :class="currentView=='checkin'?'bg-blue-600':'hover:bg-slate-700'" class="flex-1 py-4 transition">ğŸ“ æª¢éŒ„è™•</button>
            <button @click="currentView='admin'" :class="currentView=='admin'?'bg-blue-600':'hover:bg-slate-700'" class="flex-1 py-4 transition">âš–ï¸ è£åˆ¤æ§å°</button>
        </nav>

        <main class="p-4 md:p-8 flex-1">
            
            <!-- 1. æª¢éŒ„ -->
            <div v-if="currentView === 'checkin'" class="space-y-6 max-w-3xl mx-auto">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded shadow-sm">
                    <h2 class="text-xl font-bold mb-4">é¸æ‰‹å ±å</h2>
                    <div class="flex gap-2">
                        <input v-model="newPlayerName" @keyup.enter="addPlayer" type="text" placeholder="è¼¸å…¥å§“å..." class="border-2 p-2 flex-1 rounded focus:border-blue-500 outline-none">
                        <select v-model="newPlayerGroup" class="border-2 p-2 rounded w-24">
                            <option value="A">Açµ„</option>
                            <option value="B">Bçµ„</option>
                        </select>
                        <button @click="addPlayer" class="bg-blue-600 text-white px-6 rounded font-bold hover:bg-blue-700">æ·»åŠ </button>
                    </div>
                </div>
                <div class="text-right">
                    <button @click="generateTestData" class="text-xs text-gray-400 hover:text-gray-600 underline">é–‹ç™¼æ¸¬è©¦ï¼šä¸€éµç”Ÿæˆ60äºº</button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded border">
                        <h3 class="font-bold text-blue-800 mb-2">Açµ„ ({{ players.filter(p=>p.group=='A').length }})</h3>
                        <div class="h-64 overflow-y-auto text-sm space-y-1">
                            <div v-for="p in players.filter(p=>p.group=='A')" :key="p.id" class="px-2 py-1 bg-white rounded shadow-sm">{{ p.name }}</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded border">
                        <h3 class="font-bold text-green-800 mb-2">Bçµ„ ({{ players.filter(p=>p.group=='B').length }})</h3>
                        <div class="h-64 overflow-y-auto text-sm space-y-1">
                            <div v-for="p in players.filter(p=>p.group=='B')" :key="p.id" class="px-2 py-1 bg-white rounded shadow-sm">{{ p.name }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. è£åˆ¤ -->
            <div v-if="currentView === 'admin'">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">è³½ç¨‹æ§åˆ¶ä¸­å¿ƒ</h2>
                    <button @click="resetData" class="text-red-500 text-sm border border-red-200 px-3 py-1 rounded hover:bg-red-50">é‡ç½®ç³»çµ±</button>
                </div>

                <div class="flex border-b-2 border-gray-100 mb-6">
                    <button v-for="s in ['prelim', 'semi', 'final']" @click="adminStage=s" 
                        class="px-6 py-3 font-bold transition capitalize"
                        :class="adminStage===s ? 'text-blue-600 border-b-4 border-blue-600' : 'text-gray-400 hover:text-gray-600'">
                        {{ s === 'prelim' ? '1. åˆè³½' : (s === 'semi' ? '2. åŠæ±ºè³½' : '3. æ±ºè³½') }}
                    </button>
                </div>

                <!-- åˆè³½ç®¡ç† -->
                <div v-if="adminStage === 'prelim'" class="space-y-4">
                    <button @click="generatePrelims" class="w-full py-3 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 shadow">ç”Ÿæˆ/æ›´æ–° åˆè³½è³½ç¨‹</button>
                    <div class="grid lg:grid-cols-2 gap-4">
                        <div v-for="m in prelimMatches" :key="m.id" class="bg-white p-4 rounded border shadow-sm flex items-center gap-4">
                            <div class="w-20 text-xs font-bold text-gray-500 text-center">
                                <div class="px-2 py-1 text-white rounded mb-1" :class="m.group=='A'?'bg-blue-400':'bg-green-400'">{{m.group}}çµ„</div>
                                {{m.room}}
                            </div>
                            <div class="flex-1 grid grid-cols-2 gap-2">
                                <button v-for="p in m.players" @click="setWinner(m, p.id)" :disabled="!!m.winnerId"
                                    class="py-2 text-sm border rounded transition"
                                    :class="m.winnerId===p.id?'bg-green-500 text-white font-bold ring-2 ring-green-300':'hover:bg-gray-50'">
                                    {{ p.name }} <span v-if="m.winnerId===p.id">ğŸ†</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŠæ±ºè³½ç®¡ç† -->
                <div v-if="adminStage === 'semi'" class="space-y-4">
                    <button @click="generateSemis" class="w-full py-3 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700 shadow">ç”ŸæˆåŠæ±ºè³½</button>
                    <div class="grid lg:grid-cols-2 gap-4">
                        <div v-for="m in semiMatches" :key="m.id" class="bg-white p-4 rounded border shadow-sm flex items-center gap-4">
                            <div class="w-20 font-bold text-gray-500 text-center text-sm">{{m.room}}</div>
                            <div class="flex-1 flex gap-2">
                                <button v-for="p in m.players" @click="setWinner(m, p.id)" :disabled="!!m.winnerId"
                                    class="flex-1 py-3 text-sm border rounded transition"
                                    :class="m.winnerId===p.id?'bg-green-500 text-white font-bold':'hover:bg-gray-50'">
                                    {{ p.name }} <span v-if="m.winnerId===p.id">ğŸ†</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ±ºè³½ç®¡ç† (æ›´æ–°ç‰ˆï¼šå‰ä¸‰å) -->
                <div v-if="adminStage === 'final'" class="space-y-6">
                    <button @click="generateFinal" class="w-full py-3 bg-yellow-600 text-white rounded font-bold hover:bg-yellow-700 shadow">ç”Ÿæˆæ±ºè³½</button>
                    
                    <div v-for="m in finalMatches" :key="m.id" class="bg-white border-4 border-yellow-200 p-6 rounded-xl shadow-lg">
                        <h3 class="text-center font-bold text-xl text-yellow-800 mb-2">ğŸ† æ±ºè³½æ’åé¸æ‹”</h3>
                        <p class="text-center text-gray-500 text-sm mb-6">è«‹ä¾åºé»æ“Šï¼šå…ˆé»æ“Šå† è»ï¼Œå†é»æ“Šäºè»ï¼Œæœ€å¾Œé»æ“Šå­£è»ã€‚</p>
                        
                        <div class="flex flex-wrap justify-center gap-4">
                            <button v-for="p in m.players" :key="p.id" @click="toggleFinalRank(m, p.id)"
                                class="w-32 h-32 flex flex-col items-center justify-center rounded-xl border-2 transition transform hover:scale-105"
                                :class="getRankDisplay(m, p.id) ? getRankDisplay(m, p.id).color + ' ring-4 ring-opacity-50' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'">
                                
                                <span class="text-2xl mb-2">{{ getRankDisplay(m, p.id) ? getRankDisplay(m, p.id).label.split(' ')[0] : 'ğŸ‘¤' }}</span>
                                <span class="font-bold text-lg leading-tight">{{ p.name }}</span>
                                <span v-if="getRankDisplay(m, p.id)" class="text-xs mt-1 font-bold uppercase">{{ getRankDisplay(m, p.id).label.split(' ')[1] }}</span>
                            
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. è§€çœ¾è³½ç¨‹ -->
            <div v-if="currentView === 'schedule'" class="space-y-10">
                
                <!-- æ±ºè³½å±•ç¤ºå€ (æ›´æ–°è¦–è¦º) -->
                <div v-if="finalMatches.length > 0">
                    <h3 class="text-center text-3xl font-black text-yellow-600 mb-6 drop-shadow-sm">ğŸ† å·”å³°æ±ºè³½ ğŸ†</h3>
                    <div v-for="m in finalMatches" class="max-w-4xl mx-auto">
                        <!-- é ˜çå°è¦–è¦º -->
                        <div class="flex flex-wrap justify-center items-end gap-4 text-center">
                            
                            <!-- äºè» (å·¦) -->
                            <div class="order-1 w-1/3 md:w-1/4">
                                <div v-if="m.ranks && m.ranks[1]" class="flex flex-col items-center animate-bounce-in">
                                    <div class="text-xl font-bold text-gray-600 mb-2">{{ m.players.find(p=>p.id===m.ranks[1]).name }}</div>
                                    <div class="h-32 w-full bg-gradient-to-t from-gray-400 to-gray-200 rounded-t-lg shadow-lg flex items-center justify-center text-4xl border-t-4 border-gray-400">ğŸ¥ˆ</div>
                                </div>
                                <div v-else class="h-32 w-full bg-gray-100 rounded-t-lg opacity-30 flex items-center justify-center text-2xl">?</div>
                            </div>

                            <!-- å† è» (ä¸­) -->
                            <div class="order-2 w-1/3 md:w-1/4 -mt-10 z-10">
                                <div v-if="m.ranks && m.ranks[0]" class="flex flex-col items-center transform scale-110">
                                    <div class="text-2xl font-black text-yellow-600 mb-2">ğŸ‘‘ {{ m.players.find(p=>p.id===m.ranks[0]).name }}</div>
                                    <div class="h-40 w-full bg-gradient-to-t from-yellow-400 to-yellow-200 rounded-t-lg shadow-xl flex items-center justify-center text-6xl border-t-4 border-yellow-400 ring-4 ring-yellow-100">ğŸ¥‡</div>
                                </div>
                                <div v-else class="h-40 w-full bg-yellow-50 rounded-t-lg opacity-30 flex items-center justify-center text-2xl">?</div>
                            </div>

                            <!-- å­£è» (å³) -->
                            <div class="order-3 w-1/3 md:w-1/4">
                                <div v-if="m.ranks && m.ranks[2]" class="flex flex-col items-center">
                                    <div class="text-xl font-bold text-orange-700 mb-2">{{ m.players.find(p=>p.id===m.ranks[2]).name }}</div>
                                    <div class="h-24 w-full bg-gradient-to-t from-orange-400 to-orange-200 rounded-t-lg shadow-lg flex items-center justify-center text-4xl border-t-4 border-orange-400">ğŸ¥‰</div>
                                </div>
                                <div v-else class="h-24 w-full bg-orange-50 rounded-t-lg opacity-30 flex items-center justify-center text-2xl">?</div>
                            </div>
                        </div>

                        <!-- åƒè³½åå–® -->
                        <div class="mt-8 text-center">
                            <h4 class="text-gray-400 text-sm mb-2">æ±ºè³½åƒè³½è€…</h4>
                            <div class="flex flex-wrap justify-center gap-2">
                                <span v-for="p in m.players" class="px-3 py-1 bg-gray-100 rounded text-gray-600 text-sm">{{ p.name }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŠæ±ºè³½ -->
                <div v-if="semiMatches.length > 0">
                    <h3 class="text-center text-2xl font-bold text-indigo-700 mb-4 border-b-2 border-indigo-100 pb-2 inline-block mx-auto">âš”ï¸ åŠæ±ºè³½</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div v-for="m in semiMatches" class="bg-white p-4 rounded shadow border-l-4 border-indigo-500">
                            <div class="text-xs text-indigo-400 font-bold uppercase mb-2">{{ m.room }}</div>
                            <div class="flex flex-col gap-1">
                                <div v-for="p in m.players" class="flex justify-between p-2 rounded" :class="m.winnerId===p.id?'bg-indigo-100 text-indigo-900 font-bold':''">
                                    <span>{{ p.name }}</span>
                                    <span v-if="m.winnerId===p.id" class="text-xs bg-indigo-500 text-white px-2 py-0.5 rounded">æ™‰ç´š</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åˆè³½ -->
                <div v-if="prelimMatches.length > 0">
                    <h3 class="text-center text-xl font-bold text-gray-600 mb-4">ğŸ åˆè³½å°çµ„</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div v-for="m in prelimMatches" class="bg-white p-3 rounded border border-gray-200 relative">
                            <div class="absolute top-2 right-2 text-xs font-mono text-gray-300">{{ m.room }}</div>
                            <div class="text-xs font-bold mb-2 inline-block px-2 rounded text-white" :class="m.group=='A'?'bg-blue-400':'bg-green-400'">{{ m.group }}çµ„</div>
                            <div class="space-y-1 text-sm">
                                <div v-for="p in m.players" class="flex justify-between" :class="m.winnerId===p.id?'text-green-600 font-bold':''">
                                    <span>{{ p.name }}</span>
                                    <span v-if="m.winnerId===p.id">âœ…</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>
</body>
</html>