<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboMaster æ¥µé€Ÿäº‚é¬¥ç®¡ç†ç³»çµ±</title>
    <!-- å¼•å…¥ Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Tailwind CSS ç¾åŒ–ç•Œé¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Firebase (æ¨¡çµ„åŒ–ç‰ˆæœ¬éœ€é…åˆæ‰“åŒ…å·¥å…·ï¼Œé€™è£¡ä½¿ç”¨å…¼å®¹ç‰ˆç°¡åŒ–æ¼”ç¤º) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, where, writeBatch, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // â˜…â˜…â˜… è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Firebase é…ç½® â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSyBdAMarLmul5OZgC_yIBs_pfkDvA2BWLFM",
            authDomain: "robomaster-competition.firebaseapp.com",
            projectId: "robomaster-competition",
            storageBucket: "robomaster-competition.firebasestorage.app",
            messagingSenderId: "681333907764",
            appId: "1:681333907764:web:f5fb267d6f7527a1348561"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Vue æ‡‰ç”¨é‚è¼¯
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // ç‹€æ…‹è®Šæ•¸
                const currentView = ref('schedule'); // schedule, admin, checkin
                const newPlayerName = ref('');
                const newPlayerGroup = ref('A');
                const players = ref([]);
                const matches = ref([]);
                const systemStatus = ref('');

                // --- 1. æ•¸æ“šç›£è½ (å¯¦æ™‚åŒæ­¥æ ¸å¿ƒ) ---
                onMounted(() => {
                    // ç›£è½é¸æ‰‹åˆ—è¡¨
                    onSnapshot(collection(db, "players"), (snapshot) => {
                        players.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                    // ç›£è½è³½ç¨‹
                    onSnapshot(collection(db, "matches"), (snapshot) => {
                        matches.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                });

                // --- 2. æª¢éŒ„åŠŸèƒ½ ---
                const addPlayer = async () => {
                    if (!newPlayerName.value) return alert("è«‹è¼¸å…¥å§“å");
                    await addDoc(collection(db, "players"), {
                        name: newPlayerName.value,
                        group: newPlayerGroup.value,
                        status: 'registered' // registered, advanced, eliminated
                    });
                    newPlayerName.value = '';
                    alert("å ±åæˆåŠŸ");
                };

                const resetData = async () => {
                   if(!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ…é»ï¼")) return;
                   // å¯¦éš›é–‹ç™¼éœ€å¾Œç«¯åˆªé™¤ï¼Œé€™è£¡åƒ…æ¼”ç¤º
                   const pSnaps = await getDocs(collection(db, "players"));
                   pSnaps.forEach(d => deleteDoc(doc(db, "players", d.id)));
                   const mSnaps = await getDocs(collection(db, "matches"));
                   mSnaps.forEach(d => deleteDoc(doc(db, "matches", d.id)));
                   alert("æ•¸æ“šå·²é‡ç½®");
                };

                // --- 3. è£åˆ¤/ç®¡ç†åŠŸèƒ½ï¼šè³½ç¨‹ç”Ÿæˆç®—æ³• ---
                
                // æ´—ç‰Œç®—æ³•
                const shuffle = (array) => array.sort(() => Math.random() - 0.5);

                // ç”Ÿæˆåˆè³½ (A/Bçµ„åˆ†é–‹ï¼Œ4äººä¸€å±€)
                const generatePrelims = async () => {
                    const batch = writeBatch(db);
                    
                    // æ¸…é™¤èˆŠè³½ç¨‹ (ç°¡å–®èµ·è¦‹ï¼Œå¯¦éš›å¯æ¨™è¨˜round)
                    // ...æ­¤è™•çœç•¥æ¸…é™¤èˆŠmatchä»£ç¢¼ï¼Œå‡è¨­æ˜¯æ–°é–‹å§‹...

                    const groupA = shuffle(players.value.filter(p => p.group === 'A'));
                    const groupB = shuffle(players.value.filter(p => p.group === 'B'));

                    // è™•ç† A çµ„
                    for (let i = 0; i < groupA.length; i += 4) {
                        const chunk = groupA.slice(i, i + 4);
                        const matchRef = doc(collection(db, "matches"));
                        batch.set(matchRef, {
                            round: 'prelim',
                            group: 'A',
                            players: chunk,
                            room: 'Room 1', // å‡è¨­Açµ„åœ¨Room 1
                            winnerId: null
                        });
                    }
                    // è™•ç† B çµ„
                    for (let i = 0; i < groupB.length; i += 4) {
                        const chunk = groupB.slice(i, i + 4);
                        const matchRef = doc(collection(db, "matches"));
                        batch.set(matchRef, {
                            round: 'prelim',
                            group: 'B',
                            players: chunk,
                            room: 'Room 2', // å‡è¨­Bçµ„åœ¨Room 2
                            winnerId: null
                        });
                    }
                    await batch.commit();
                    alert("åˆè³½è³½ç¨‹å·²ç”Ÿæˆï¼");
                };

                // ç”ŸæˆåŠæ±ºè³½ (åˆä½µæ™‰ç´šè€…ï¼Œ3äººä¸€å±€)
                const generateSemis = async () => {
                    const winners = matches.value
                        .filter(m => m.round === 'prelim' && m.winnerId)
                        .map(m => m.players.find(p => p.id === m.winnerId));
                    
                    if (winners.length === 0) return alert("æ²’æœ‰åˆè³½æ™‰ç´šè€…");

                    const shuffledWinners = shuffle([...winners]); // è¤‡è£½ä¸¦æ´—ç‰Œ
                    const batch = writeBatch(db);

                    for (let i = 0; i < shuffledWinners.length; i += 3) {
                        const chunk = shuffledWinners.slice(i, i + 3);
                        const matchRef = doc(collection(db, "matches"));
                        batch.set(matchRef, {
                            round: 'semi',
                            group: 'Merged',
                            players: chunk,
                            room: i % 2 === 0 ? 'Room 1' : 'Room 2', // éš¨æ©Ÿåˆ†é…æˆ¿é–“
                            winnerId: null
                        });
                    }
                    await batch.commit();
                    alert("åŠæ±ºè³½è³½ç¨‹å·²ç”Ÿæˆï¼");
                };

                // ç”Ÿæˆæ±ºè³½ (5äººä¸€å±€)
                const generateFinal = async () => {
                    const winners = matches.value
                        .filter(m => m.round === 'semi' && m.winnerId)
                        .map(m => m.players.find(p => p.id === m.winnerId));
                    
                    if (winners.length === 0) return alert("æ²’æœ‰åŠæ±ºè³½æ™‰ç´šè€…");

                    await addDoc(collection(db, "matches"), {
                        round: 'final',
                        group: 'Final',
                        players: winners, // æ‡‰è©²æ˜¯5äºº
                        room: 'Main Stage',
                        winnerId: null,
                        rank: [] // æ±ºè³½ç”¨æ–¼å­˜å„²æ’å
                    });
                    alert("æ±ºè³½å·²ç”Ÿæˆï¼");
                };

                // --- 4. è£åˆ¤æ“ä½œ ---
                const setWinner = async (match, winnerId) => {
                    if(!confirm("ç¢ºèªé¸å®šå‹åˆ©è€…ï¼Ÿ")) return;
                    await updateDoc(doc(db, "matches", match.id), {
                        winnerId: winnerId
                    });
                };
                
                const setRank = async (match, rankData) => {
                    // æ±ºè³½å°ˆç”¨é‚è¼¯
                };

                // è¨ˆç®—å±¬æ€§ï¼šåˆ†é¡é¡¯ç¤ºè³½ç¨‹
                const prelimMatches = computed(() => matches.value.filter(m => m.round === 'prelim'));
                const semiMatches = computed(() => matches.value.filter(m => m.round === 'semi'));
                const finalMatches = computed(() => matches.value.filter(m => m.round === 'final'));

                return {
                    currentView, newPlayerName, newPlayerGroup, players, 
                    addPlayer, resetData,
                    generatePrelims, generateSemis, generateFinal,
                    prelimMatches, semiMatches, finalMatches,
                    setWinner
                };
            }
        }).mount('#app');
    </script>
</head>
<body class="bg-gray-100 p-4">
    <div id="app" class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg min-h-screen">
        
        <!-- å°èˆªæ¬„ -->
        <nav class="flex border-b">
            <button @click="currentView='schedule'" :class="{'border-b-2 border-blue-500 text-blue-600': currentView=='schedule'}" class="flex-1 py-4 text-center font-bold">è³½ç¨‹ & æ™‰ç´š</button>
            <button @click="currentView='checkin'" :class="{'border-b-2 border-blue-500 text-blue-600': currentView=='checkin'}" class="flex-1 py-4 text-center font-bold">æª¢éŒ„ (Check-in)</button>
            <button @click="currentView='admin'" :class="{'border-b-2 border-blue-500 text-blue-600': currentView=='admin'}" class="flex-1 py-4 text-center font-bold">è£åˆ¤ (Admin)</button>
        </nav>

        <!-- 1. æª¢éŒ„é é¢ -->
        <div v-if="currentView === 'checkin'" class="p-6">
            <h2 class="text-xl font-bold mb-4">é¸æ‰‹æª¢éŒ„</h2>
            <div class="flex gap-2 mb-6">
                <input v-model="newPlayerName" type="text" placeholder="é¸æ‰‹å§“å" class="border p-2 flex-1 rounded">
                <select v-model="newPlayerGroup" class="border p-2 rounded">
                    <option value="A">Açµ„</option>
                    <option value="B">Bçµ„</option>
                </select>
                <button @click="addPlayer" class="bg-blue-500 text-white px-6 py-2 rounded">æ·»åŠ </button>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded">
                    <h3 class="font-bold mb-2">Açµ„åå–® ({{ players.filter(p=>p.group=='A').length }}äºº)</h3>
                    <ul><li v-for="p in players.filter(p=>p.group=='A')" :key="p.id">{{ p.name }}</li></ul>
                </div>
                <div class="bg-green-50 p-4 rounded">
                    <h3 class="font-bold mb-2">Bçµ„åå–® ({{ players.filter(p=>p.group=='B').length }}äºº)</h3>
                    <ul><li v-for="p in players.filter(p=>p.group=='B')" :key="p.id">{{ p.name }}</li></ul>
                </div>
            </div>
        </div>

        <!-- 2. è£åˆ¤é é¢ -->
        <div v-if="currentView === 'admin'" class="p-6">
            <h2 class="text-xl font-bold mb-4">è³½ç¨‹æ§åˆ¶ä¸­å¿ƒ</h2>
            <div class="flex gap-2 mb-6 border-b pb-4">
                <button @click="generatePrelims" class="bg-purple-600 text-white px-4 py-2 rounded">ç”Ÿæˆåˆè³½ (4äºº)</button>
                <button @click="generateSemis" class="bg-indigo-600 text-white px-4 py-2 rounded">ç”ŸæˆåŠæ±ºè³½ (3äºº)</button>
                <button @click="generateFinal" class="bg-yellow-600 text-white px-4 py-2 rounded">ç”Ÿæˆæ±ºè³½ (5äºº)</button>
                <button @click="resetData" class="bg-red-500 text-white px-4 py-2 rounded ml-auto">é‡ç½®ç³»çµ±</button>
            </div>

            <div v-for="match in [...prelimMatches, ...semiMatches, ...finalMatches]" :key="match.id" class="mb-4 border p-4 rounded shadow-sm bg-gray-50">
                <div class="flex justify-between mb-2">
                    <span class="font-bold badge bg-gray-200 px-2 rounded">{{ match.round.toUpperCase() }} - {{ match.room }}</span>
                    <span v-if="match.winnerId" class="text-green-600 font-bold">å·²çµæŸ</span>
                    <span v-else class="text-red-500">é€²è¡Œä¸­</span>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button 
                        v-for="p in match.players" 
                        :key="p.id"
                        @click="setWinner(match, p.id)"
                        :class="match.winnerId === p.id ? 'bg-green-500 text-white' : 'bg-white border hover:bg-gray-100'"
                        class="px-4 py-2 rounded flex-1 transition"
                        :disabled="!!match.winnerId"
                    >
                        {{ p.name }}
                        <span v-if="match.winnerId === p.id">ğŸ†</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. è³½ç¨‹/è§€çœ¾é é¢ -->
        <div v-if="currentView === 'schedule'" class="p-6">
            <h2 class="text-2xl font-bold mb-6 text-center">ğŸ† å³æ™‚è³½ç¨‹è¡¨ ğŸ†</h2>

            <!-- æ±ºè³½å€ -->
            <div v-if="finalMatches.length > 0" class="mb-8">
                <h3 class="text-xl font-bold bg-yellow-100 p-2 rounded text-center mb-2">æ±ºè³½ (æ’åè³½)</h3>
                <div v-for="m in finalMatches" class="border-2 border-yellow-400 p-4 rounded text-center">
                    <div class="text-lg font-bold mb-2">å·”å³°å°æ±º</div>
                    <div class="flex justify-center gap-4">
                        <div v-for="p in m.players" class="bg-yellow-50 px-4 py-2 rounded">
                            {{ p.name }}
                            <span v-if="m.winnerId === p.id">ğŸ¥‡</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŠæ±ºè³½å€ -->
            <div v-if="semiMatches.length > 0" class="mb-8">
                <h3 class="text-xl font-bold bg-indigo-100 p-2 rounded text-center mb-2">åŠæ±ºè³½ (3äººäº‚é¬¥ -> 1æ™‰ç´š)</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div v-for="(m, idx) in semiMatches" class="border p-3 rounded bg-white shadow-sm">
                        <div class="text-gray-500 text-sm mb-1">å ´æ¬¡ S-{{idx+1}} ({{ m.room }})</div>
                        <div class="flex flex-col gap-1">
                            <div v-for="p in m.players" :class="{'bg-green-100 font-bold': m.winnerId===p.id}" class="p-1 rounded flex justify-between">
                                <span>{{ p.name }}</span>
                                <span v-if="m.winnerId===p.id" class="text-green-600">æ™‰ç´š</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆè³½å€ -->
            <div>
                <h3 class="text-xl font-bold bg-blue-100 p-2 rounded text-center mb-2">åˆè³½ (A/Bçµ„ 4äººäº‚é¬¥ -> 1æ™‰ç´š)</h3>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="(m, idx) in prelimMatches" class="border p-3 rounded bg-white shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 right-0 px-2 py-0.5 text-xs text-white" :class="m.group==='A'?'bg-blue-400':'bg-green-400'">
                            {{ m.group }}çµ„
                        </div>
                        <div class="text-gray-500 text-sm mb-1">å ´æ¬¡ P-{{idx+1}}</div>
                        <div class="flex flex-col gap-1">
                            <div v-for="p in m.players" :class="{'bg-green-100 font-bold': m.winnerId===p.id}" class="p-1 rounded flex justify-between text-sm">
                                <span>{{ p.name }} </span>
                                <span v-if="m.winnerId===p.id">âœ…</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</body>
</html>